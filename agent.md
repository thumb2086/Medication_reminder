# Dynamic Agent Workflow: Context-Aware & Data Integrity (v3)

此工作流程設計為動態切換模式。**核心原則：規劃與執行分離，文件更新視為原子操作。**

## 🛑 核心檔案操作原則 (CRITICAL I/O RULES)
**Agent 在操作文件時必須嚴格遵守以下規則：**

1.  **`log.md` 的「無日期追加」 (No-Date Append Strategy):**
    *   **嚴禁使用日期：** **不要**猜測或插入當前日期（如 [2024-xx-xx]），因為往往不準確。
    *   **格式規範：** 標題僅使用 **`## 版本號`** 或 **`## 任務名稱`** (例如：`## v1.2.0 UI Refactor` 或 `## Fix Login Bug`)。
    *   **嚴禁覆蓋：** 必須先讀取舊內容 -> 追加新 Log -> 寫回完整內容。
2.  **`todo.md` 的「滾動式清理」 (Rolling Cleanup Strategy):**
    *   **執行前清理 (Pre-Clean):** 準備執行代碼前，**必須刪除**文件中**原本已經存在**的已完成項目 (`[x]`)，保持清單乾淨。
    *   **完成時標記 (Mark Current):** 本次任務完成後，將當前的 `[ ]` 修改為 `[x]`，**保留此行**以便使用者確認本次成果。
3.  **同步性 (Synchronization):**
    *   程式碼修改 (`.kt`/`.java`) 與文件修改 (`README`/`log`/`todo`) 必須在**同一次回應**中完成。

---

## 邏輯判斷流程 (Logic Flow)

### 1. Mode A: 規劃與維護 (Architect & Plan) - [DEFAULT]
**觸發:** 指令涉及修改文檔、討論功能、新增需求、或指令不明確。
**禁止:** **嚴禁修改任何 `.kt`, `.java`, `.xml`, Gradle 或資源檔。**

*   **Step 1: 需求分析:** 理解使用者意圖。
*   **Step 2: 更新 `todo.md`:**
    *   新增待辦事項 `[ ]`。
    *   此階段**不執行**清理舊 `[x]` 的動作，除非使用者特別要求。
*   **Step 3: 停止 (Halt):**
    *   更新完文檔後立即停止，回報規劃結果。

### 2. Mode B: 開發與執行 (Develop & Execute)
**觸發:** 收到明確指令（如 `開始`, `執行`, `Implement`） **且** `todo.md` 有未完成項目。

*   **Phase 1: 準備與清理 (Prep & Clean)**
    1.  讀取 `todo.md`。
    2.  **執行清理：** 刪除所有**舊的**已完成項目 (`[x] ...`)。
    3.  鎖定當前要執行的 `[ ]` 任務。

*   **Phase 2: 實作 (Code)**
    1.  根據鎖定的任務修改程式碼 (Write Code)。
    2.  自我檢查/模擬編譯 (Verify)。

*   **Phase 3: 文件同步與結案 (Sync & Close) - *強制執行***
    *   **在此階段完成前，任務不算結束。**
    1.  **更新 `log.md` (Append, NO DATES):**
        *   讀取舊內容，在末尾追加。
        *   **標題：** 使用 `## {Task Name}` 或 `## {Version}`。
        *   內容：記錄技術細節、變更檔案。
    2.  **更新 `todo.md` (Mark):**
        *   將剛完成的任務由 `[ ]` 改為 `[x]`。
    3.  **更新 `README.md` (如有必要):**
        *   若涉及新功能、UI 變更或設定調整，必須同步更新中英文說明。

---

## 狀態回報範本 (Response Templates)

請根據當前狀態選擇回應模板：

**[Mode A] 規劃完成:**
> "已更新 `todo.md` 新增待辦事項。**尚未開始寫 Code**。
> 請確認規劃，若無誤請輸入『開始執行』。"

**[Mode B] 執行完畢:**
> "✅ **執行完畢**
> 1. **清理**: 已移除 `todo.md` 中舊的 `[x]` 項目。
> 2. **實作**: 已完成 {功能名稱}。
> 3. **狀態**: `todo.md` 本次任務已打勾 `[x]`。
> 4. **紀錄**: `log.md` 已追加紀錄（**不含日期**）。
>
> 請檢查結果。"

---

### 修改確認：
1.  **Log 無日期**：在 **Critical I/O Rules** 與 **Mode B Phase 3** 中，明確寫入「嚴禁使用日期」、「不要猜測日期」，改用版本或任務名當標題。
2.  **Todo 邏輯維持**：執行前刪除舊的 `[x]`，執行後標記新的 `[x]`。
3.  **Log 防刪**：維持 Append-Only 規則。