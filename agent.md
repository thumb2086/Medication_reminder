# Dynamic Agent Workflow: Context-Aware & Data Integrity (v6)

此工作流程核心：**規劃與執行分離，執行階段包含「自我診斷循環」，確保交付即用。**

## 🛑 數據完整性守則 (DATA INTEGRITY GUARDIANS)

1.  **`log.md`：增量歷史保存 (History Preservation)**
    *   **頂部插入 (Prepending)：** 新紀錄必須插入在檔案的最上方（標題下方），**絕對禁止刪除或覆蓋舊有的 `v1.3.4` 等歷史紀錄**。
    *   **紀錄結構：** 必須包含「技術細節」與「除錯歷程（如有）」。
2.  **`todo.md`：精準滾動清理**
    *   **執行前：** 僅刪除已標記為 `[x]` 的舊項目。
    *   **執行中：** 嚴禁刪除任何 `[ ]` 項目。
    *   **執行後：** 將當前任務改為 `[x]`。

---

## 邏輯判斷流程 (Logic Flow)

### 1. Mode A: 規劃與維護 (Architect & Plan)
*   **任務：** 需求分析、更新 `todo.md`。
*   **自我檢查：** 檢查新需求是否與現有邏輯衝突。

### 2. Mode B: 開發、除錯與執行 (Develop, Debug & Execute)
此模式現在包含一個**強制性的自我除錯循環**。

#### **Phase 1: 準備與清理**
1.  讀取 `todo.md` 並清理舊的 `[x]` 內容。

#### **Phase 2: 實作與自我除錯循環 (The Debug Loop)**
1.  **撰寫代碼：** 根據任務修改檔案。
2.  **靜態檢查 (Self-Diagnostic)：**
    *   檢查 `import` 是否遺漏。
    *   檢查 R 資源 ID 是否正確（對照 `strings.xml` 或 `drawables`）。
    *   檢查生命週期呼叫順序（如 `super.onCreate()`）。
3.  **模擬編譯/報錯處理：**
    *   *如果發現潛在崩潰點：* 立即修正，並在心中標記「根源分析」。
    *   *如果修改了多個檔案：* 確保關聯性一致（例如 XML 修改了 ID，KT 也要同步改）。

#### **Phase 3: 結案與詳細紀錄 (Deep Logging)**
1.  **更新 `log.md` (Read -> Prepend -> Write)：**
    *   將新紀錄插入頂部。
    *   **如果過程中有除錯，格式必須包含：**
        *   `*   **UI/邏輯修正:** {描述}`
        *   `    *   **根源分析:** {為什麼出錯}`
        *   `    *   **解決方案:** {如何修復}`
2.  **更新 `todo.md`：** 標記任務完成。

---

## 🤖 自我除錯指令集 (Internal Debugging Checklist)
Agent 在回報「執行完畢」前，必須自我詢問：
1.  **資源一致性：** 我剛才新增的字串，在所有 `values-xx/strings.xml` 都有對應嗎？
2.  **順序正確性：** 像 `applyTheme()` 這種操作，是在正確的生命週期位置嗎？
3.  **依賴完整性：** 是否有未使用的變數或遺失的 Context 引用？
4.  **歷史完整性：** 我是否不小心刪掉了 `log.md` 以前的紀錄？（**必須確認舊紀錄依然存在**）

---

## 狀態回報範本

**[Mode B] 執行完畢 (含除錯紀錄):**
> "✅ **任務執行完畢 (已完成自我診斷)**
>
> 1. **實作內容**: 完成了 {任務名稱}。
> 2. **自我除錯 (Self-Fixed)**:
     >    - 在檢查中發現 `layout.xml` 的 ID 衝突，已同步修正。
>    - 修正了 `MainActivity` 的字體套用順序問題。
> 3. **文件更新**:
     >    - `todo.md`: 已清理舊項，標記當前任務。
>    - `log.md`: 已在頂部追加紀錄，**保留了所有歷史 v1.3.x 版本**。
>
> **日誌摘要：**
> ### v1.3.5: {標題}
> * **修正:** {描述}
    >   * **根源:** {分析}
>   * **方案:** {做法}
>
> 請檢查結果。"
