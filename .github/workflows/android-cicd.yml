name: Android CI/CD

on:
  push:
    branches:
      - "dev"
      - "fix-*"
      - "feat-*"
    tags:
      - 'v*'
  delete: {}
  workflow_dispatch:
    inputs:
      target_branch_name:
        description: 'æ‰‹å‹•æ¸…ç†çš„åˆ†æ”¯åç¨± (ä¾‹å¦‚ feat/new-fun)'
        required: true
        type: string

jobs:
  # ========================================================
  # Job 1: Build & Release
  # ========================================================
  build:
    name: Build and Release
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # [é‚è¼¯çµ±ä¸€] å‘½åæ¨™æº–åŒ–ï¼šå…¨æ•¸è½‰ç‚ºæ¸›è™Ÿ (-)
      - name: Determine Channel & Tag Name
        id: names
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
             echo "IS_OFFICIAL=true" >> $GITHUB_ENV
             # For official release, we can default channel to 'main' or just use the tag as version
             echo "CHANNEL_NAME=main" >> $GITHUB_ENV
          else
             RAW_BRANCH=${GITHUB_REF#refs/heads/}
             # feat/new_fun -> feat-new-fun
             SAFE_NAME=$(echo "$RAW_BRANCH" | tr '/_' '-')
          
             echo "CHANNEL_NAME=$SAFE_NAME" >> $GITHUB_ENV
             
             # æ”¹å‹•ï¼šä¸å†åªä½¿ç”¨ nightly-<branch>ï¼Œæ”¹ç‚º nightly-<branch>-<build_number> æˆ–å…¶ä»–å¾Œç¶´
             # ä½† Release Tag å¿…é ˆæ˜¯å›ºå®šçš„ (mutable tag) æ‰èƒ½è¦†è“‹ç™¼å¸ƒï¼Œ
             # æˆ–æ˜¯æ¡ç”¨ immutable tag ç­–ç•¥ (æ¯æ¬¡ç™¼å¸ƒæ–° Tag)ã€‚
             # æ­¤å°ˆæ¡ˆæ¡ç”¨ mutable release ç­–ç•¥ (æ›´æ–°åŒä¸€å€‹ Release)ã€‚
             # æ‰€ä»¥ Tag Name ç¶­æŒä¸è®Šï¼Œä½† Release Title æœƒåœ¨å¾Œé¢çš„æ­¥é©Ÿå‹•æ…‹è¨­å®šã€‚
             echo "TAG_NAME=nightly-$SAFE_NAME" >> $GITHUB_ENV
             echo "IS_OFFICIAL=false" >> $GITHUB_ENV
          fi

      - name: Grant Execute Permission for Gradlew
        run: chmod +x gradlew

      # [é˜²å‘†] ç”¢ç”Ÿ google-services.jsonï¼Œé˜²æ­¢ Build å¤±æ•—
      - name: Decode Secrets
        run: |
          if [ ! -z "${{ secrets.GOOGLE_SERVICES_JSON }}" ]; then
            echo "${{ secrets.GOOGLE_SERVICES_JSON }}" > app/google-services.json
          else
            echo '{"project_info":{"project_number":"000000000000","project_id":"dummy-project","storage_bucket":"dummy.appspot.com"},"client":[{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000","android_client_info":{"package_name":"com.example.dummy"}},"api_key":[{"current_key":"dummy_key"}]}]}' > app/google-services.json
            echo "::warning::Generated dummy google-services.json because secret is empty."
          fi
          
          if [ ! -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
             echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release.keystore
          fi

      # 1. ä¿®æ”¹ Version Code ç”Ÿæˆé‚è¼¯ (æ”¹ç”¨ GitHub Run Number ç¢ºä¿å”¯ä¸€ä¸”éå¢)
      # åˆªé™¤æˆ–è¨»è§£æ‰èˆŠçš„ Generate Version Code æ­¥é©Ÿ
      # - name: Generate Version Code ...

      - name: Build with Gradle
        env:
          # ğŸ”¥ é—œéµï¼šæŠŠ YAML ç®—å‡ºä¾†çš„ safe name (ä¾‹å¦‚ fix-app-update) å‚³é€²å»
          CHANNEL_NAME: ${{ env.CHANNEL_NAME }} 
          RELEASE_KEYSTORE_PATH: ./release.keystore
          RELEASE_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          BUILD_NUMBER: ${{ github.run_number }}
          # ğŸ”¥ é—œéµï¼šä½¿ç”¨æ–°çš„ Version Code (GitHub Run Number)
          # ä¸è¦åœ¨é€™è£¡ç”¨ dateï¼Œä¹Ÿä¸è¦ç•™ç©ºè®“ Gradle è‡ªå·±ç®—
          VERSION_CODE_OVERRIDE: ${{ github.run_number }}
        run: ./gradlew assembleRelease

      # [å„ªåŒ–] ç›´æ¥å°‹æ‰¾ Gradle ç”Ÿæˆçš„å¸¶æœ‰ç‰ˆæœ¬è™Ÿçš„ APK
      - name: Find and Rename APK
        run: |
          # å–å¾— Gradle è¨ˆç®—å‡ºçš„å®Œæ•´ç‰ˆæœ¬åç¨± (e.g., 1.2.1-dev-255)
          GRADLE_VERSION_NAME=$(./gradlew -q app:printVersionName | tail -n 1)
          echo "Gradle reported versionName: $GRADLE_VERSION_NAME"

          # å°‹æ‰¾ release ç›®éŒ„ä¸‹çš„ APK
          # Gradle output: MedicationReminder-v1.2.1-dev-255-release.apk
          SRC_APK=$(find app/build/outputs/apk/release -name "*.apk" | head -n 1)
          
          if [ -z "$SRC_APK" ]; then
             echo "::error::No APK found in app/build/outputs/apk/release"
             exit 1
          fi
          
          echo "Found APK: $SRC_APK"
          
          # å°‡æª”åä¸­çš„ "-release" ç§»é™¤ï¼Œä¿æŒç°¡æ½”
          # MedicationReminder-v1.2.1-dev-255-release.apk -> MedicationReminder-v1.2.1-dev-255.apk
          FILENAME=$(basename "$SRC_APK")
          NEW_FILENAME=${FILENAME//-release/}
          
          if [ "$FILENAME" != "$NEW_FILENAME" ]; then
              mv "$SRC_APK" "app/build/outputs/apk/release/$NEW_FILENAME"
              echo "Renamed to: $NEW_FILENAME"
          fi
          
          APK_FILENAME="$NEW_FILENAME"
          FINAL_VERSION_NAME="$GRADLE_VERSION_NAME"
          
          echo "APK_FILENAME=$APK_FILENAME" >> $GITHUB_ENV
          echo "VERSION_NAME=$FINAL_VERSION_NAME" >> $GITHUB_ENV
          echo "::notice::Final APK: $APK_FILENAME (Version: $FINAL_VERSION_NAME)"

      # --- Official Release ---
      # Need to generate JSON for main channel as well if we want Nightly builds to be able to "update" to stable
      - name: Generate Main Channel JSON (Official)
        if: env.IS_OFFICIAL == 'true'
        run: |
          mkdir -p public
          # Use "update_main.json" for stable releases so other channels can find it
          JSON_FILE="update_main.json" 
          # Assuming the tag is the release tag
          TAG_NAME="${{ github.ref_name }}"
          APK_URL="https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/${{ env.APK_FILENAME }}"
          
          # ğŸ”¥ ä½¿ç”¨ github.run_number
          cat <<EOF > public/$JSON_FILE
          {
            "latestVersion": "${{ env.VERSION_NAME }}",
            "versionCode": ${{ github.run_number }},
            "url": "$APK_URL",
            "releaseNotes": "Stable release $TAG_NAME"
          }
          EOF
          cp public/$JSON_FILE .
          
      - name: Deploy Main JSON to GitHub Pages
        if: env.IS_OFFICIAL == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: true

      - name: Create Official Release
        if: env.IS_OFFICIAL == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            app/build/outputs/apk/release/${{ env.APK_FILENAME }}
            update_main.json
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- Nightly Release ---
      - name: Generate Channel JSON
        if: env.IS_OFFICIAL == 'false'
        run: |
          mkdir -p public
          JSON_FILE="update_${{ env.CHANNEL_NAME }}.json"
          APK_URL="https://github.com/${{ github.repository }}/releases/download/${{ env.TAG_NAME }}/${{ env.APK_FILENAME }}"
          
          # ğŸ”¥ ä½¿ç”¨ github.run_number
          cat <<EOF > public/$JSON_FILE
          {
            "latestVersion": "${{ env.VERSION_NAME }}",
            "versionCode": ${{ github.run_number }},
            "url": "$APK_URL",
            "releaseNotes": "Nightly build for ${{ env.CHANNEL_NAME }}"
          }
          EOF
          cp public/$JSON_FILE .

      - name: Deploy JSON to GitHub Pages
        if: env.IS_OFFICIAL == 'false'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: true

      - name: Create Nightly Release
        if: env.IS_OFFICIAL == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          # [å‘½åä¿®æ­£] Release Title å„ªåŒ–: <Branch> | <VersionName>
          name: "${{ env.CHANNEL_NAME }} | ${{ env.VERSION_NAME }}"
          target_commitish: ${{ github.sha }} # [å„ªåŒ–] ç¢ºä¿ Tag æŒ‡å‘æœ€æ–° Commit
          files: |
            app/build/outputs/apk/release/${{ env.APK_FILENAME }}
            update_${{ env.CHANNEL_NAME }}.json
          prerelease: true
          body: "Auto-generated nightly build for channel ${{ env.CHANNEL_NAME }}.\nVersion: ${{ env.VERSION_NAME }}\nCommit: ${{ github.sha }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ========================================================
  # Job 2: Cleanup (æš´åŠ›åˆªé™¤ + ä¸¦ç™¼ä¿è­·)
  # ========================================================
  cleanup:
    name: Cleanup Release & JSON
    if: >
      (github.event_name == 'delete' && github.event.ref_type == 'branch') || 
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Determine Target
        id: target
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            RAW_BRANCH="${{ inputs.target_branch_name }}"
            echo "::notice::Trigger: Manual Dispatch for $RAW_BRANCH"
          else
            RAW_BRANCH="${{ github.event.ref }}"
            echo "::notice::Trigger: Branch Deletion for $RAW_BRANCH"
          fi
          
          # [é‚è¼¯çµ±ä¸€] å¿…é ˆèˆ‡ Build Job å®Œå…¨ä¸€è‡´ (tr '/_' '-')
          SAFE_NAME=$(echo "$RAW_BRANCH" | tr '/_' '-')
          
          TAG_NAME="nightly-$SAFE_NAME"
          JSON_FILE="update_${SAFE_NAME}.json"
          
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "JSON_FILE=$JSON_FILE" >> $GITHUB_ENV
          
          echo "::notice::Targeting -> Tag: $TAG_NAME | JSON: $JSON_FILE"

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Debug - List Releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Current Releases (Top 5) ==="
          gh release list --limit 5 || echo "Failed to list releases"
          echo "================================"

      # 1. ç¬¬ä¸€åˆ€ï¼šå˜—è©¦åˆªé™¤ Release (æº«å’Œ)
      - name: Delete GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release delete "${{ env.TAG_NAME }}" --cleanup-tag --yes || echo "::warning::Release not found via API."

      # 2. ç¬¬äºŒåˆ€ï¼šGit å¼·åˆ¶åˆªé™¤ Tag (æš´åŠ›)
      - name: Force Delete Git Tag
        run: |
          git push origin --delete "refs/tags/${{ env.TAG_NAME }}" || echo "::notice::Git Tag already gone."

      # 3. æ¸…ç† JSON (å«ä¸¦ç™¼ä¿è­·)
      - name: Cleanup JSON from gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Remove JSON File
        run: |
          TARGET_FILE="${{ env.JSON_FILE }}"
          
          # [å„ªåŒ–] ä¸¦ç™¼ä¿è­·ï¼šå…ˆæ‹‰å–æœ€æ–°è®Šæ›´ï¼Œé¿å… Push Rejected
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git pull origin gh-pages --rebase
          
          if [ -f "$TARGET_FILE" ]; then
            git rm "$TARGET_FILE"
            git commit -m "Cleanup $TARGET_FILE"
            git push origin gh-pages
            echo "::notice::Successfully removed $TARGET_FILE"
          else
            echo "::notice::File $TARGET_FILE not found on gh-pages. Nothing to do."
          fi