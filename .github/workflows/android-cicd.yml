name: Android CI/CD

on:
  # 1. 自動觸發：推送到開發分支或打正式 Tag
  push:
    branches:
      - "dev"
      - "fix-*"
      - "feat-*"
    tags:
      - 'v*'
  
  # 2. 自動觸發：刪除分支時
  delete: {}

  # 3. 【新功能】手動觸發：專門用來清理殘留的垃圾
  workflow_dispatch:
    inputs:
      target_branch_name:
        description: '輸入要清理的分支原始名稱 (例如 fix-nightly-del-bench)'
        required: true
        type: string

jobs:
  # ========================================================
  # Job 1: 建置與發布 (Build & Release)
  # ========================================================
  build:
    name: Build and Release
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      # 核心邏輯：計算 Channel 名稱 (統一邏輯)
      - name: Determine Channel & Tag Name
        id: names
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
             echo "Triggered by Official Tag."
             echo "IS_OFFICIAL=true" >> $GITHUB_ENV
          else
             # 取得分支名稱 (移除 refs/heads/)
             RAW_BRANCH=${GITHUB_REF#refs/heads/}
             
             # 【統一邏輯點】將 / 和 - 替換為 _
             SAFE_NAME=$(echo "$RAW_BRANCH" | sed 's/[\/\-]/\_/g')
             
             echo "CHANNEL_NAME=$SAFE_NAME" >> $GITHUB_ENV
             echo "TAG_NAME=nightly-$SAFE_NAME" >> $GITHUB_ENV
             echo "IS_OFFICIAL=false" >> $GITHUB_ENV
             
             echo "Mode: Nightly | Channel: $SAFE_NAME | Tag: nightly-$SAFE_NAME"
          fi

      - name: Grant Execute Permission for Gradlew
        run: chmod +x gradlew

      - name: Decode Secrets
        run: |
          # Google Services
          if [ ! -z "${{ secrets.GOOGLE_SERVICES_JSON }}" ]; then
            echo "${{ secrets.GOOGLE_SERVICES_JSON }}" > app/google-services.json
          else
            echo "{}" > app/google-services.json
          fi
          
          # Keystore (使用 base64 寫入檔案)
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release.keystore

      - name: Generate Version Code
        run: |
          TIMESTAMP=$(date +'%y%m%d%H')
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

      - name: Build with Gradle
        env:
          RELEASE_KEYSTORE_PATH: ./release.keystore
          RELEASE_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          BUILD_NUMBER: ${{ github.run_number }}
          VERSION_CODE_OVERRIDE: ${{ env.TIMESTAMP }}
        run: ./gradlew assembleRelease

      - name: Rename APK
        id: rename_apk
        run: |
          VERSION_NAME=$(./gradlew -q app:printVersionName)
          SAFE_VERSION=$(echo "$VERSION_NAME" | sed 's/ /-/g')
          
          SRC_APK=$(find app/build/outputs/apk/release -name "*.apk" | head -n 1)
          NEW_FILENAME="MedicationReminder-$SAFE_VERSION.apk"
          
          mv "$SRC_APK" "app/build/outputs/apk/release/$NEW_FILENAME"
          echo "APK_FILENAME=$NEW_FILENAME" >> $GITHUB_ENV
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV

      # --- 1. 正式版發布 ---
      - name: Create Official Release
        if: env.IS_OFFICIAL == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: app/build/outputs/apk/release/${{ env.APK_FILENAME }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- 2. Nightly 版發布與 JSON 更新 ---
      - name: Generate Channel JSON
        if: env.IS_OFFICIAL == 'false'
        run: |
          mkdir -p public
          JSON_FILE="update_${{ env.CHANNEL_NAME }}.json"
          APK_URL="https://github.com/${{ github.repository }}/releases/download/${{ env.TAG_NAME }}/${{ env.APK_FILENAME }}"
          
          cat <<EOF > public/$JSON_FILE
          {
            "latestVersion": "${{ env.VERSION_NAME }}",
            "versionCode": ${{ env.TIMESTAMP }},
            "url": "$APK_URL",
            "releaseNotes": "Nightly build for ${{ env.CHANNEL_NAME }}"
          }
          EOF
          
          # 複製一份到當前目錄給 Release 用
          cp public/$JSON_FILE .

      - name: Deploy JSON to GitHub Pages
        if: env.IS_OFFICIAL == 'false'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: true # 重要：保留其他頻道的 JSON

      - name: Create Nightly Release
        if: env.IS_OFFICIAL == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          files: |
            app/build/outputs/apk/release/${{ env.APK_FILENAME }}
            update_${{ env.CHANNEL_NAME }}.json
          prerelease: true
          body: "Auto-generated nightly build for channel ${{ env.CHANNEL_NAME }}."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ========================================================
  # Job 2: 清理 (Cleanup) - 支援 自動刪除 與 手動刪除
  # ========================================================
  cleanup:
    name: Cleanup Release & JSON
    # 觸發條件：是刪除分支事件 OR 是手動觸發 (workflow_dispatch)
    if: >
      (github.event_name == 'delete' && github.event.ref_type == 'branch') || 
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Determine Target Branch Name
        id: target
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # 手動輸入的分支名
            RAW_BRANCH="${{ inputs.target_branch_name }}"
            echo "Trigger: Manual Dispatch"
          else
            # 刪除事件的分支名
            RAW_BRANCH="${{ github.event.ref }}"
            echo "Trigger: Branch Deletion"
          fi
          
          # 【統一邏輯點】確保與 Build Job 完全一致 (sed 寫法)
          SAFE_NAME=$(echo "$RAW_BRANCH" | sed 's/[\/\-]/\_/g')
          TAG_NAME="nightly-$SAFE_NAME"
          JSON_FILE="update_${SAFE_NAME}.json"
          
          echo "Processing Branch: $RAW_BRANCH"
          echo "Target Tag: $TAG_NAME"
          echo "Target JSON: $JSON_FILE"
          
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "JSON_FILE=$JSON_FILE" >> $GITHUB_ENV

      - name: Delete GitHub Release and Tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Deleting Release/Tag: ${{ env.TAG_NAME }}"
          # 使用 || true 忽略錯誤 (如果已經手動刪除了也不會報錯)
          gh release delete "${{ env.TAG_NAME }}" --cleanup-tag --yes || echo "Release/Tag not found or already deleted."

      - name: Cleanup JSON from gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          
      - name: Remove JSON File
        run: |
          TARGET_FILE="${{ env.JSON_FILE }}"
          if [ -f "$TARGET_FILE" ]; then
            echo "Removing $TARGET_FILE from gh-pages..."
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            
            # 使用 git rm 刪除並提交
            git rm "$TARGET_FILE"
            git commit -m "Cleanup $TARGET_FILE (triggered by cleanup)"
            git push origin gh-pages
          else
            echo "File $TARGET_FILE does not exist on gh-pages. Skipping."
          fi
