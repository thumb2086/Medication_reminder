name: Android CI/CD

on:
  push:
    branches:
      - "dev"
      - "fix-*"
      - "feat-*"
    tags:
      - 'v*'
  delete: {}
  workflow_dispatch:
    inputs:
      target_branch_name:
        description: 'æ‰‹å‹•æ¸…ç†çš„åˆ†æ”¯åç¨± (ä¾‹å¦‚ feat/new-fun)'
        required: true
        type: string

jobs:
  # ========================================================
  # Job 1: Build & Release
  # ========================================================
  build:
    name: Build and Release
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Determine Version & Channel
        id: versioning
        run: |
          # 1. è¨ˆç®— Git Commit Count (é€™å°±æ˜¯æˆ‘å€‘è¦çš„ VersionCode)
          COMMIT_COUNT=$(git rev-list --count HEAD)
          echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_ENV
          echo "Calculated Commit Count: $COMMIT_COUNT"

          # 2. è‡ªå‹•æŠ“å–å…¨åŸŸæœ€æ–°çš„ Git Tag (ä¸ç®¡æœ‰ç„¡ Merge)
          # --sort=-v:refname æœƒå°‡ v1.2.1 æ’åœ¨ v1.2.0 å‰é¢
          # head -n 1 å–å‡ºç¬¬ä¸€è¡Œ
          LATEST_TAG=$(git tag --list 'v*' --sort=-v:refname | head -n 1 || echo "v1.0.0")
          # å»æ‰ 'v' å‰ç¶´ (e.g. v1.2.1 -> 1.2.1)
          BASE_VERSION=${LATEST_TAG#v}
          echo "Calculated Base Version from Global Tags: $BASE_VERSION"
          
          # å°‡æŠ“åˆ°çš„ Base Version å¯«å…¥ç’°å¢ƒè®Šæ•¸ï¼Œä¹‹å¾Œå‚³çµ¦ Gradle
          echo "BASE_VERSION_OVERRIDE=$BASE_VERSION" >> $GITHUB_ENV

          # 3. æ±ºå®š Channel Name & Tag Name
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
             # --- æƒ…å¢ƒ Aï¼šæ­£å¼ç™¼å¸ƒ (Tag Push) ---
             echo "IS_OFFICIAL=true" >> $GITHUB_ENV
             echo "CHANNEL_NAME=main" >> $GITHUB_ENV
             echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV
          else
             # --- æƒ…å¢ƒ Bï¼šåˆ†æ”¯é–‹ç™¼ (Nightly/Dev) ---
             RAW_BRANCH=${GITHUB_REF#refs/heads/}
             SAFE_NAME=$(echo "$RAW_BRANCH" | tr '/_' '-')
             echo "CHANNEL_NAME=$SAFE_NAME" >> $GITHUB_ENV
             # ğŸ”¥ TAG_NAME åŒ…å«ç‰ˆæœ¬è™Ÿï¼Œç¢ºä¿å”¯ä¸€æ€§èˆ‡å¯è¿½æº¯æ€§
             echo "TAG_NAME=${BASE_VERSION}-nightly-${SAFE_NAME}-${COMMIT_COUNT}" >> $GITHUB_ENV
             echo "IS_OFFICIAL=false" >> $GITHUB_ENV
          fi

      - name: Grant Execute Permission for Gradlew
        run: chmod +x gradlew

      - name: Decode Secrets
        run: |
          if [ ! -z "${{ secrets.GOOGLE_SERVICES_JSON }}" ]; then
            echo "${{ secrets.GOOGLE_SERVICES_JSON }}" > app/google-services.json
          else
            echo '{"project_info":{"project_number":"000000000000","project_id":"dummy-project","storage_bucket":"dummy.appspot.com"},"client":[{"client_info":{"mobilesdk_app_id":"1:000000000000:android:0000000000000000","android_client_info":{"package_name":"com.example.dummy"}},"api_key":[{"current_key":"dummy_key"}]}]}' > app/google-services.json
          fi
          
          if [ ! -z "${{ secrets.KEYSTORE_BASE64 }}" ]; then
             echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release.keystore
          fi

      - name: Build with Gradle
        env:
          # ğŸ”¥ ä¿®æ”¹ï¼šä½¿ç”¨çµ•å°è·¯å¾‘ï¼Œç¢ºä¿ Gradle ä¸€å®šæ‰¾å¾—åˆ°æª”æ¡ˆ
          RELEASE_KEYSTORE_PATH: ${{ github.workspace }}/release.keystore
          RELEASE_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        # ğŸ”¥ ä¿®æ”¹ï¼šå‚³å…¥ git rev-list ç®—å‡ºä¾†çš„ COMMIT_COUNTï¼Œè€Œä¸æ˜¯ run_number
        # ğŸ”¥ ä¿®æ”¹ï¼šå‚³å…¥ BASE_VERSION_OVERRIDE è¦†å¯« Gradle è£¡çš„è¨­å®š
        run: ./gradlew assembleRelease -PciVersionCode=${{ env.COMMIT_COUNT }} -PciChannelName=${{ env.CHANNEL_NAME }} -PciBaseVersion=${{ env.BASE_VERSION_OVERRIDE }} || exit 1

      - name: Find and Rename APK
        run: |
          # åŒæ¨£å‚³å…¥ COMMIT_COUNT å’Œ BaseVersion è®“ Gradle print å‡ºæ­£ç¢ºçš„ç‰ˆæœ¬å
          GRADLE_VERSION_NAME=$(./gradlew -q app:printVersionName -PciVersionCode=${{ env.COMMIT_COUNT }} -PciChannelName=${{ env.CHANNEL_NAME }} -PciBaseVersion=${{ env.BASE_VERSION_OVERRIDE }} | tail -n 1)
          echo "Gradle reported versionName: $GRADLE_VERSION_NAME"

          SRC_APK=$(find app/build/outputs/apk/release -name "*.apk" | head -n 1)
          
          if [ -z "$SRC_APK" ]; then
             echo "::error::No APK found"
             exit 1
          fi
          
          FILENAME=$(basename "$SRC_APK")
          NEW_FILENAME=${FILENAME//-release/}
          
          if [ "$FILENAME" != "$NEW_FILENAME" ]; then
              mv "$SRC_APK" "app/build/outputs/apk/release/$NEW_FILENAME"
          fi
          
          echo "APK_FILENAME=$NEW_FILENAME" >> $GITHUB_ENV
          echo "VERSION_NAME=$GRADLE_VERSION_NAME" >> $GITHUB_ENV

      # --- Official Release ---
      - name: Generate Main Channel JSON (Official)
        if: env.IS_OFFICIAL == 'true'
        run: |
          mkdir -p public
          JSON_FILE="update_main.json" 
          TAG_NAME="${{ github.ref_name }}"
          APK_URL="https://github.com/${{ github.repository }}/releases/download/$TAG_NAME/${{ env.APK_FILENAME }}"
          
          # ğŸ”¥ é—œéµä¿®æ­£ï¼šJSON è£¡é¢çš„ VersionCode å¿…é ˆæ˜¯ Commit Count
          cat <<EOF > public/$JSON_FILE
          {
            "latestVersion": "${{ env.VERSION_NAME }}",
            "versionCode": ${{ env.COMMIT_COUNT }},
            "url": "$APK_URL",
            "releaseNotes": "Stable release $TAG_NAME"
          }
          EOF
          cp public/$JSON_FILE .
          
      - name: Deploy Main JSON to GitHub Pages
        if: env.IS_OFFICIAL == 'true'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: true

      - name: Create Official Release
        if: env.IS_OFFICIAL == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            app/build/outputs/apk/release/${{ env.APK_FILENAME }}
            update_main.json
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- Nightly Release ---
      - name: Generate Channel JSON
        if: env.IS_OFFICIAL == 'false'
        run: |
          mkdir -p public
          JSON_FILE="update_${{ env.CHANNEL_NAME }}.json"
          APK_URL="https://github.com/${{ github.repository }}/releases/download/${{ env.TAG_NAME }}/${{ env.APK_FILENAME }}"
          
          # ğŸ”¥ é—œéµä¿®æ­£ï¼šJSON è£¡é¢çš„ VersionCode å¿…é ˆæ˜¯ Commit Count
          cat <<EOF > public/$JSON_FILE
          {
            "latestVersion": "${{ env.VERSION_NAME }}",
            "versionCode": ${{ env.COMMIT_COUNT }},
            "url": "$APK_URL",
            "releaseNotes": "Nightly build for ${{ env.CHANNEL_NAME }}"
          }
          EOF
          cp public/$JSON_FILE .

      - name: Deploy JSON to GitHub Pages
        if: env.IS_OFFICIAL == 'false'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          keep_files: true
      
      - name: Cleanup Old Nightly Release
        if: env.IS_OFFICIAL == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          KEYWORD="${{ env.CHANNEL_NAME }}"
          echo "Searching for old releases containing '$KEYWORD' to cleanup..."
          
          # åˆ—å‡ºæ‰€æœ‰ Releaseï¼Œéæ¿¾å‡ºåŒ…å«é—œéµå­— (Branch Name) çš„ Release
          TAGS_TO_DELETE=$(gh release list --limit 100 | grep "$KEYWORD" | awk '{print $1}')
          
          if [ -z "$TAGS_TO_DELETE" ]; then
            echo "No old releases found for $KEYWORD."
          else
            echo "Deleting old releases: $TAGS_TO_DELETE"
            for tag in $TAGS_TO_DELETE; do
               gh release delete "$tag" --cleanup-tag --yes || echo "Failed to delete $tag"
            done
          fi

      - name: Create Nightly Release
        if: env.IS_OFFICIAL == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "${{ env.CHANNEL_NAME }} | ${{ env.VERSION_NAME }}"
          target_commitish: ${{ github.sha }}
          files: |
            app/build/outputs/apk/release/${{ env.APK_FILENAME }}
            update_${{ env.CHANNEL_NAME }}.json
          prerelease: true
          body: "Nightly build for ${{ env.CHANNEL_NAME }}.\nVersion: ${{ env.VERSION_NAME }}\nVersionCode: ${{ env.COMMIT_COUNT }}\nCommit: ${{ github.sha }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ========================================================
  # Job 2: Cleanup (å‡ç´šç‰ˆï¼šæ”¯æ´å‹•æ…‹ç‰ˆæœ¬è™Ÿåˆªé™¤)
  # ========================================================
  cleanup:
    name: Cleanup Release & JSON
    if: >
      (github.event_name == 'delete' && github.event.ref_type == 'branch') || 
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Determine Target Branch Name
        id: target
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            RAW_BRANCH="${{ inputs.target_branch_name }}"
          else
            RAW_BRANCH="${{ github.event.ref }}"
          fi
          
          # æ¨™æº–åŒ–åˆ†æ”¯åç¨± (fix/app-update -> fix-app-update)
          SAFE_NAME=$(echo "$RAW_BRANCH" | tr '/_' '-')
          echo "TARGET_KEYWORD=$SAFE_NAME" >> $GITHUB_ENV
          
          echo "::notice::Will search and destroy releases containing: $SAFE_NAME"

      - name: Checkout Code
        uses: actions/checkout@v4

      # ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ JSON æ¨¡å¼ç²¾æº–æŠ“å– Tag åç¨±
      - name: Delete Matching Releases & Tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          KEYWORD="${{ env.TARGET_KEYWORD }}"
          echo "ğŸ” Searching for releases containing keyword: '$KEYWORD'..."
          
          # 1. æŠ“å–æ‰€æœ‰ Tag åç¨± (ä½¿ç”¨ JSON è¼¸å‡ºé¿å…æ ¼å¼è·‘æ‰)
          # 2. ä½¿ç”¨ grep éæ¿¾å‡ºåŒ…å«é—œéµå­—çš„ Tag
          TAGS_TO_DELETE=$(gh release list --limit 100 --json tagName --jq '.[].tagName' | grep "$KEYWORD")
          
          if [ -z "$TAGS_TO_DELETE" ]; then
            echo "âš ï¸ No releases found containing '$KEYWORD'. Nothing to delete."
          else
            echo "âœ… Found tags to delete:"
            echo "$TAGS_TO_DELETE"
            
            # 3. è¿´åœˆåˆªé™¤
            for tag in $TAGS_TO_DELETE; do
              echo "ğŸ—‘ï¸ Deleting Release & Tag: $tag"
              
              # åˆªé™¤ Release
              gh release delete "$tag" --cleanup-tag --yes || echo "::warning::Failed to delete release $tag via API"
              
              # å¼·åˆ¶åˆªé™¤ Git Tag (é›™é‡ä¿éšª)
              git push origin --delete "refs/tags/$tag" || echo "::notice::Git tag $tag already gone."
            done
          fi

      # 2. æ¸…ç† gh-pages ä¸Šçš„ JSON (ä¿æŒä¸è®Š)
      - name: Cleanup JSON from gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0 
          
      - name: Remove JSON File
        run: |
          # JSON æª”åé€šå¸¸æ¯”è¼ƒå›ºå®šï¼Œé‚„æ˜¯å¯ä»¥ç”¨æ¨æ¸¬çš„
          JSON_FILE="update_${{ env.TARGET_KEYWORD }}.json"
          
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          if [ -f "$JSON_FILE" ]; then
            git rm "$JSON_FILE"
            git commit -m "Cleanup $JSON_FILE"
            git pull --rebase origin gh-pages
            git push origin gh-pages
            echo "::notice::Successfully removed $JSON_FILE"
          else
            echo "::notice::File $JSON_FILE not found on gh-pages."
          fi