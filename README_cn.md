# 智能藥盒提醒 App

這是一款 Android 應用程式，旨在幫助使用者管理他們的藥物服用排程，並透過藍牙低功耗 (BLE) 技術與智能藥盒互動。

## 設計理念

本專案的核心設計是將複雜的邏輯處理保留在 Android App 中，讓智能藥盒 (ESP32) 的職責盡可能單純，只作為一個忠實的時間與指令執行者。這樣的設計大大簡化了硬體端的韌體開發，提高了系統的穩定性與省電效率。

## 主要功能

*   **分頁式介面:**
    *   採用 `TabLayout` 和 `ViewPager2` 打造現代化的分頁式介面，分為「提醒設定」、「藥物列表」、「服藥紀錄」和「環境監測」四大功能區塊，操作更直覺。
*   **完整的藥物管理 (CRUD):**
    *   在「提醒設定」頁面，您可以動態新增、編輯和刪除藥物提醒。
    *   為每種藥物設定名稱、劑量、服藥時間、起訖日期，**總藥量將自動計算**。
    *   智慧的藥倉互斥機制，防止您將多種藥物設定到同一個藥倉。
*   **可靠的鬧鐘提醒:**
    *   在您設定的每個服藥時間，App 都會發送精確的本地通知。
    *   即使 App 未在前景執行，或手機重新開機，鬧鐘依然有效。
    *   通知中包含「已服用」和「稍後提醒」操作，方便快速互動。
*   **藍牙智能藥盒整合:**
    *   **引導式放藥 (Guided Filling):** 新增藥物時，App 會引導您逐一完成。每設定完一筆藥物，藥盒會自動旋轉到對應藥倉，讓您直接放入藥物，並透過藥盒上的按鈕確認，實現軟硬體結合的流暢體驗。
    *   掃描並連接到智能藥盒。
    *   與藥盒同步時間及各藥倉的用藥提醒。
    *   接收藥盒的狀態更新，例如：哪個藥倉的藥物已被取出、藥倉堵塞、感應器錯誤等。
*   **數據監測與追蹤:**
    *   在「環境監測」頁面，當藍牙連接時，透過 **即時折線圖** 視覺化呈現藥盒回傳的溫濕度數據；未連接時，則会顯示提示訊息。使用者可透過 **下拉刷新** 的手勢，同步離線期間的 **歷史溫濕度數據**，並完整呈現在圖表上。
*   **服藥紀錄:** 
    *   在「服藥紀錄」頁面，透過月曆視覺化呈現每日服藥記錄，並計算顯示過去 30 天的服藥依從率。
*   **設定:**
    *   可透過工具列上的設定圖示進入設定頁面。
    *   支援亮色、暗色和跟隨系統主題的切換。
    *   **角色主題**: 將 App 的主題顏色與角色選擇功能綁定。選擇「酷洛米」會將主題色切換為紫色，選擇「櫻桃小丸子」則會切換為粉紅色，增添使用樂趣。
    *   **工程模式:** 在設定中提供開關，其狀態能與藥盒雙向同步，真實反映藥盒當前的模式。

## App 架構

本 App 採用 **MVVM (Model-View-ViewModel)** 架構，將 UI 與業務邏輯分離，使程式碼更模組化、易於維護。

*   **View:** 由 `Activity` 和 `Fragment` 組成，負責顯示 UI 及處理使用者互動。
*   **ViewModel:** `MainViewModel` 負責持有及管理與 UI 相關的數據，它能在螢幕旋轉等配置變更後繼續存在，並與數據層溝通。**現已導入 Hilt 進行依賴注入**。
*   **Model:**
    *   **Repository:** `AppRepository` 作為所有數據的單一來源 (Single Source of Truth)，負責抽象化底層的數據來源。它是一個由 **Hilt** 提供的單例 (Singleton)。
    *   **Data Sources:**
        *   `BluetoothLeManager`: 管理所有 BLE 通訊，**現已改為由 Hilt 注入**。
        *   `SharedPreferences`: 儲存藥物清單、使用者設定等。

## 使用說明

1.  **新增藥物 (引導式放藥流程):**
    *   在「提醒設定」分頁，選擇您要一次新增的藥物數量，系統會自動產生對應的輸入欄位。
    *   填寫完所有藥物的資訊（名稱、劑量、頻率、藥倉等）後，點擊「新增藥物提醒」。
    *   **藥盒自動轉動:** App 會鎖定畫面並發送指令，讓藥盒自動轉到 **第一筆藥物** 對應的藥倉。
    *   **放入藥物並確認:** 畫面上會提示您將藥物放入指定的藥倉。完成後，**直接按下藥盒上的實體按鈕**。
    *   **重複流程:** App 收到確認訊號後，會再次發送指令，讓藥盒轉到 **下一筆藥物** 的藥倉。您只需重複「放藥 -> 按按鈕」的動作，直到所有藥物都已放入。
    *   **完成同步:** 全部完成後，App 會將所有提醒一次性同步給藥盒，並解除畫面鎖定。
2.  **編輯或刪除藥物:**
    *   點擊「提醒設定」分頁下方的 **「編輯提醒」** 或 **「刪除提醒」** 按鈕。
    *   App 會彈出一個包含所有已設定藥物的列表。
    *   從列表中選擇您想操作的藥物。
    *   **編輯:** 選擇後，該藥物的資訊會自動填入上方的表單中。修改後點擊「更新藥物」即可。
    *   **刪除:** 選擇後，在跳出的確認對話框中進行確認即可刪除。
3.  **連接藥盒:**
    *   點擊「提醒設定」分頁的「連接藥盒」按鈕。App 會開始掃描並讓您選擇您的智能藥盒進行配對。

## 藍牙通訊協定 (Bluetooth Protocol)

為實現 App 與藥盒的互動，我們定義了一套基於位元組陣列 (Byte Array) 的雙向通訊協定。`BluetoothLeManager` 類別負責將指令封裝成位元組陣列並發送，同時也負責解析從藥盒收到的數據。

### Service 與 Characteristics UUID

- **Service UUID:** `4fafc201-1fb5-459e-8fcc-c5c9c331914b`
- **Write Characteristic UUID:** `beb5483e-36e1-4688-b7f5-ea07361b26a8` (App -> 藥盒)
- **Notify Characteristic UUID:** `c8c7c599-809c-43a5-b825-1038aa349e5d` (藥盒 -> App)

### App -> 藥盒 (指令)

所有指令均透過寫入 **Write Characteristic** 發送。

1.  **請求協定版本 (Request Protocol Version):**
    - **指令碼:** `0x01`
    - **用途:** 詢問藥盒當前的協定版本。
    - **格式 (1 byte):** `[0]: 0x01`

2.  **時間同步 (Time Sync):**
    - **指令碼:** `0x11`
    - **格式 (7 bytes):** `[0]: 0x11`, `[1]: 年-2000`, `[2]: 月`, `[3]: 日`, `[4]: 時`, `[5]: 分`, `[6]: 秒`

3.  **傳送 Wi-Fi 憑證 (Send Wi-Fi Credentials):**
    - **指令碼:** `0x12`
    - **格式 (可變長度):** `[0]: 0x12`, `[1]: SSID長度`, `[2...]: SSID`, `[...]: 密碼長度`, `[...]: 密碼`

4.  **設定工程模式 (Set Engineering Mode):**
    - **指令碼:** `0x13`
    - **用途:** 命令藥盒啟用或停用工程模式。
    - **格式 (2 bytes):** `[0]: 0x13`, `[1]: 啟用 (0x01 為 true, 0x00 為 false)`

5.  **請求工程模式狀態 (Request Engineering Mode Status):**
    - **指令碼:** `0x14`
    - **用途:** 主動向藥盒查詢其當前的工程模式狀態。
    - **格式 (1 byte):** `[0]: 0x14`

6.  **請求藥盒狀態 (Request Status):**
    - **指令碼:** `0x20`
    - **用途:** 主動向藥盒查詢其當前狀態（例如各藥倉是否有藥）。
    - **格式 (1 byte):** `[0]: 0x20`

7.  **請求即時環境數據 (Request Instant Environment Data):**
    - **指令碼:** `0x30`
    - **用途:** 主動向藥盒請求目前的即時溫濕度數據。
    - **格式 (1 byte):** `[0]: 0x30`

8.  **請求歷史環境數據 (Request Historic Environment Data):**
    - **指令碼:** `0x31`
    - **用途:** 請求藥盒開始傳輸其儲存的所有歷史溫濕度數據。
    - **格式 (1 byte):** `[0]: 0x31`

9.  **訂閱即時環境數據 (Subscribe Realtime Environment Data):**
    - **指令碼:** `0x32`
    - **用途:** 訂閱即時環境數據推送。
    - **格式 (1 byte):** `[0]: 0x32`

10. **取消訂閱即時環境數據 (Unsubscribe Realtime Environment Data):**
    - **指令碼:** `0x33`
    - **用途:** 取消訂閱即時環境數據推送。
    - **格式 (1 byte):** `[0]: 0x33`

### 藥盒 -> App (通知)

所有通知均透過 **Notify Characteristic** 發送。App 在 `handleIncomingData(data: ByteArray)` 方法中解析這些數據。

1.  **協定版本回報 (Protocol Version Report):**
    - **指令碼:** `0x71`
    - **格式 (2 bytes):** `[0]: 0x71`, `[1]: 版本 (例如 0x02 代表 V2)`
    - **用途:** 回報藥盒當前的協定版本。

2.  **藥盒狀態回報 (Box Status Update):**
    - **指令碼:** `0x80`
    - **格式 (2 bytes):** `[0]: 0x80`, `[1]: 藥倉狀態位元遮罩`

3.  **藥物已取出回報 (Medication Taken Report):**
    - **指令碼:** `0x81`
    - **格式 (2 bytes):** `[0]: 0x81`, `[1]: 藥倉編號`

4.  **時間同步確認 (Time Sync Acknowledged):**
    - **指令碼:** `0x82`
    - **格式 (1 byte):** `[0]: 0x82`

5.  **工程模式狀態回報 (Engineering Mode Status Report):**
    - **指令碼:** `0x83`
    - **用途:** 回報藥盒當前的工程模式狀態。
    - **格式 (2 bytes):** `[0]: 0x83`, `[1]: 狀態 (0x01 為啟用, 0x00 為關閉)`

6.  **即時溫濕度數據回報 (Instant Sensor Data Report):**
    - **指令碼:** `0x90`
    - **格式 (5 bytes):** `[0]: 0x90`, `[1-2]: 溫度`, `[3-4]: 濕度` (Little Endian, 數值*100)

7.  **歷史溫濕度數據批次 (Historic Sensor Data Batch):**
    - **指令碼:** `0x91`
    - **格式 (可變, 9-41 bytes):** `[0]: 0x91`, `[1...]: 1至5筆歷史紀錄`
    - ***注意:*** *此協定變更需要 ESP32 韌體同步更新。*

8.  **歷史數據傳輸結束 (End of Historic Data Transmission):**
    - **指令碼:** `0x92`
    - **格式 (1 byte):** `[0]: 0x92`

9.  **異常狀態回報 (Error Report):**
    - **指令碼:** `0xEE`
    - **格式 (2 bytes):** `[0]: 0xEE`, `[1]: 錯誤碼`

## 專案結構

(專案結構說明與前版相同，此處省略)

## 權限需求

`POST_NOTIFICATIONS`, `BLUETOOTH_SCAN`, `BLUETOOTH_CONNECT`, `ACCESS_FINE_LOCATION`, `SCHEDULE_EXACT_ALARM`, `RECEIVE_BOOT_COMPLETED`, `VIBRATE`

## 最近更新
*   **0099:** **實作 Repository 模式並解決 Hilt 注入限制。**
    *   **架構重構:** 建立了單例 `AppRepository`，將所有資料邏輯（SharedPreferences、藥物列表、溫濕度歷史、服藥狀態）從 `MainViewModel` 中抽離。
    *   **Hilt 修正:** 解決了 `MedicationTakenReceiver` 無法直接注入 `ViewModel` 的 Dagger Hilt 限制。現在，Receiver 透過 Hilt EntryPoint 注入 `AppRepository`，而 `MainViewModel` 也改為依賴這個 Repository，確保了資料存取的單一性與架構的正確性。
*   **0098:** **修復通知「我已服用」後的數據同步與通知取消問題。**
    *   **問題:** `MedicationTakenReceiver` 錯誤地實例化了新的 `MainViewModel`，導致服藥事件無法更新到應用程式的單例 ViewModel 中，服藥紀錄和圖表無法更新。此外，通知有時無法自動消失。
    *   **修正:** 在 `MedicationTakenReceiver.kt` 中導入了 Hilt 的 `EntryPoint` 模式，以確保廣播接收器可以存取到正確的單例 `MainViewModel` 和 `BluetoothLeManager` 實例。同時，確保了 `notificationId` 被正確用於取消通知，解決了通知殘留的問題。
*   **0094:** **圖表視覺與互動優化。**
    *   **雙軸顯示:** 實作了溫度 (左軸) 與濕度 (右軸) 的雙 Y 軸顯示，解決了數值範圍差異導致的顯示問題。
    *   **視覺簡化:** 移除了圖表上的圓點，僅保留曲線與填充，使畫面更加現代簡潔。加入進場動畫與下拉刷新動畫。
    *   **互動增強:** 新增了 `CustomMarkerView`，當使用者長按圖表時，會顯示選中點的具體時間與數值。
*   **0093:** **修復藍牙連接時的未知錯誤代碼 3。**
    *   **問題分析:** 錯誤代碼 3 發生在 Android App 傳送新的「請求協定版本 (0x01)」指令時，但 `esp32.ino` 韌體中尚未實作此指令，導致韌體回報未知指令錯誤 (0x03)。
    *   **韌體修復:** 在 `esp32.ino` 中新增了 `CMD_REQUEST_PROTOCOL_VERSION (0x01)` 和 `CMD_REPORT_PROTOCOL_VERSION (0x71)` 的定義。
    *   **邏輯實作:** 在 `handleCommand` 中新增邏輯，當收到 `0x01` 時，回傳當前韌體協定版本 `0x02`，使 App 能夠順利完成協定同步，消除連線錯誤。
*   **0092:** **實作即時環境數據訂閱機制與圖表優化。**
    *   **協定升級:** 新增 `0x32` (訂閱) 與 `0x33` (取消訂閱) 指令。
    *   **App 優化:** `EnvironmentFragment` 改用 `LineChart`，並修正了數據解析邏輯。
*   **0091:** **修復圖表顯示問題與優化藍牙診斷。**
    *   **問題修復:** 修正了 `EnvironmentFragment` 中 MPAndroidChart 的精度問題。
    *   **診斷增強:** 在 `BluetoothLeManager` 中加入了詳細的 Log 輸出。
*   **0090:** **導入 Hilt 實現依賴注入。**
    *   **重構範圍:** 為 `MainViewModel` 和 `BluetoothLeManager` 導入 Hilt 依賴注入。
    *   **程式碼修改:**
        *   在 `build.gradle.kts` 中設定 Hilt。
        *   建立 `MedicationReminderApplication` 並在 `AndroidManifest.xml` 中註冊。
        *   為 `MainActivity` 和 `MainViewModel` 加上 Hilt 註解。
        *   建立 `AppModule` 來提供 `BluetoothLeManager` 的實例。
    *   **優點:** 降低了元件之間的耦合度，提高了程式碼的可測試性和可維護性。
*   **0089:** **將 `MainViewModel` 中的 `LiveData` 重構為 `StateFlow`。**
    *   **重構範圍:** `isBleConnected`, `bleStatus`, `isEngineeringMode`, `historicSensorData`, `medicationList`, `dailyStatusMap`, and `complianceRate`。
    *   **UI 層更新:** 同步更新了 `MainActivity` 和所有相關的 Fragment，改為使用 `lifecycleScope.launch` 和 `repeatOnLifecycle` 來收集 `StateFlow` 的更新。
    *   **優點:** 提高了 UI 狀態管理的可預測性、線程安全性。
*   **0088:** **引入藍牙協定版本控制並規劃未來優化方向。**
    *   **協定版本化:** 新增了 `0x01`（請求協定版本）和 `0x71`（回報協定版本）指令。
    *   **文件更新:** 在 README 檔案中新增了「通訊協定版本化」和「未來優化方向」章節。
*   **0086:** 實現了 App 與藥盒之間工程模式狀態的雙向同步。
*   **0085:** 優化了藍牙協定與 App 的數據處理邏輯，引入了歷史數據的批次處理。
*   **0084:** 調整了歷史溫濕度數據的同步時機，改為由使用者下拉刷新觸發。
*   **0083:** 優化了溫濕度數據的藍牙傳輸協定。
*   **0082:** 修正了工具列標題的垂直對齊問題。
*   **0081:** 修正了工具列標題的顯示問題。
*   **0080:** 修正了因為標題置中而導致的嚴重錯誤。
*   **0079:** 清理了 `MainActivity.kt` 中的多個警告。
*   **0078:** 修正了工具列標題沒有置中的問題。
*   **0077:** 修正了在設定頁面中，返回按鈕顏色不正確的問題。
*   **0076:** 徹底解決了工具列在角色主題下，文字與圖示顏色不正確的問題。
*   **0075:** 再次修正了工具列的文字與圖示顏色問題。
*   **0074:** 修正了 App 在淺色主題下，工具列和狀態列的文字與圖示顏色不正確的問題。
*   **0072:** 徹底重新設計了 App 的 UI 並解決了因此產生的建置錯誤。
*   **0071:** 修正了在淺色主題下，Toolbar 和狀態列上的文字與圖示顏色不正確的問題。
*   **0070:** 修正了在挖孔螢幕上，狀態列背景無法正確填滿的沉浸式 UI 問題。
*   **0069:** 將輔助顏色功能與角色選擇功能綁定，並徹底解決了狀態列的沉浸式顯示問題。
*   **0068:** 徹底重新設計了 App 的 UI 並解決了因此產生的建置錯誤。
*   **0067:** 修正了 `MainActivity.kt` 中因缺少 `WindowInsetsCompat` 的匯入而導致的編譯錯誤。
*   **0066:** 再次修正了工具列與狀態列的 UI 顯示問題。
*   **0065:** 修正了 `strings.xml` 中因單引號使用不當而引起的 Linter 錯誤。
*   **0064:** 修正了 `strings.xml` 和 `values-en/strings.xml` 中因不正確的跳脫字元和單引號用法而導致的 Linter 錯誤。
*   **0063:** 修正了工具列與狀態列的 UI 顯示問題。
*   **0062:** 修正了多個 UI 和功能上的錯誤。
*   **0061:** 修正了 UI 顯示問題和設定按鈕的功能異常。
*   **0059:** 修正了狀態列遮擋工具列標題的問題。
*   **0058:** 修正了當輔助顏色設為「預設」時，工具列顏色不正確的問題。
*   **0057:** 修正了 `MainActivity.kt` 中因 `activity_main.xml` 佈局變更而導致的編譯錯誤。
*   **0056:** 復原了 0055 號的 Bug 修復，以解決 `AndroidManifest.xml` 的資源連結失敗問題。
*   **0055:** 再次修正了圖片遮擋輸入欄位的 UI 問題。
*   **0054:** 修正了 `ReminderSettingsFragment` 在挖孔螢幕上顯示異常，以及圖片遮擋輸入欄位的 UI 問題。
*   **0053:** 修正了輔助顏色在暗色模式下無法正確同步的問題。
*   **0052:** 為提醒設定頁面新增了中斷藍牙連線的功能。
*   **0015:** 修正了服藥正確率未更新及服藥紀錄頁面時間顯示不清楚的問題。
*   **0060:** 新增了角色更換功能。
*   **0049:** 清理了專案中的多個警告。
*   **0047:** 新增了「工程模式」。
*   **0045:** 為設定頁面與 Wi-Fi 設定頁面新增了返回按鈕。
*   **0044:** 為藥物提醒通知新增「稍後提醒」與「已服用」操作。
*   **0043:** 修正了 `WiFiConfigFragment` 的背景透明問題。
*   **0042:** 新增 Wi-Fi 設定介面。
*   **0041:** 修正了無障礙功能警告。
*   **0040:** 修正了 `themes.xml` 中的資源連結錯誤。
*   **0039:** 修正了 `MainActivity.kt` 中的多個棄用警告。
*   **0038:** 在設定頁面新增了返回箭頭。
*   **0.037:** 修正了設定頁面的 UI 顯示問題。
*   **0036:** 修正了設定圖示在亮色模式下不可見的問題。
*   **0035:** 在設定頁面中新增了語言切換功能。
*   **0034:** 為應用程式新增英文本地化。
*   **0033:** 實作了歷史溫濕度數據同步功能。
*   **0032:** 修正了專案中的多個編譯錯誤與警告。
*   **0031:** 清理了 `app/src/main/java/com/example/medicationreminderapp/ui/` 目錄中所有重複且空白的檔案。
*   **0030:** 實作了藍牙協定中「App 主動請求溫濕度數據」的功能。
*   **0029:** 修正了 `app/build.gradle.kts` 中的多個 build 錯誤與警告。
*   **0028:** 修復了因移除 `BluetoothLeManager` 中看似未使用的 `requestStatus()` 和 `syncTime()` 方法而導致的 Build 失敗問題。
*   **0027:** 移除了 `BluetoothLeManager.kt` 中未被使用的 `sendJson` 方法。
*   **0026:** 清理了專案中多個「未使用宣告」的警告。
*   **0025:** 移除了 `Medication` data class 中未被使用的 `frequency` 欄位。
*   **0024:** 修復了 IDE 中的多個警告。
*   **0023:** 在服藥紀錄頁面新增了視覺標示功能。
*   **0022:** 簡化了版本號碼的設定。
*   **0021:** 清理了 `SettingsFragment.kt` 中的警告。
*   **0020:** 恢復了遺失的設定功能。
*   **0019:** 解決了 `fragment_reminder_settings.xml` 中的無障礙警告。
*   **0018:** 解決了 IDE 中出現的 XML 資源解析錯誤。
*   **0017:** 解決了 IDE 中出現的 XML 資源解析錯誤。
*   **0016:** 恢復了編輯和刪除藥物提醒的功能。
*   **0015:** 修正了新增藥物後，藥物列表不會立即更新的 UI 問題。
*   **0014:** 處理了 IDE 中關於 `MedicationListAdapter.kt` 和 `ReminderSettingsFragment.kt` 的過時警告。
*   **0013:** 清理了專案中的所有警告。
*   **0012:** 清理了專案中的所有警告。
*   **0011:** 修正了因缺少 `androidx.preference:preference-ktx` 依賴項而導致的資源連結錯誤。
*   **0010:** 新增了設定頁面和藥物列表頁面。
*   **0009:** 優化了藥物提醒表單的驗證。
*   **0008:** 修正了因 Gradle 版本目錄不完整而導致的嚴重建置錯誤。
