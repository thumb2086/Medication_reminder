# 藥到叮嚀 (Medication Reminder App)

一個結合 ESP32 智慧藥盒的藥物提醒應用程式。協助使用者追蹤服藥時間、監測環境溫濕度，並透過手機通知與硬體警示雙重提醒，確保按時服藥。

[![Android CI/CD](https://github.com/thumb2086/Medication_reminder/actions/workflows/android-cicd.yml/badge.svg)](https://github.com/thumb2086/Medication_reminder/actions/workflows/android-cicd.yml)

## 功能特色

*   **智慧提醒:** 可自訂藥物名稱、服用頻率與時間。
*   **硬體整合:** 透過藍牙低功耗 (BLE) 與 ESP32 智慧藥盒無縫連接。
*   **即時監測:** 顯示藥盒回傳的即時溫度與濕度數據。
*   **服藥追蹤:** 自動記錄服藥歷史，並產生圖表分析服藥正確率。
*   **角色主題:** 提供「酷洛米」與「櫻桃小丸子」兩種主題風格供選擇。
*   **工程模式:** 可直接從 App 切換藥盒的工程模式，方便進行硬體診斷。
*   **Wi-Fi 設定:** 透過 BLE 直接設定 ESP32 的 Wi-Fi 連線資訊 (SSID 與密碼)，現已整合至設定頁面中。
*   **鬧鐘系統:** 支援設定最多 4 組硬體鬧鐘，讓藥盒能獨立運作提醒。
*   **互動圖表:** 透過互動式折線圖檢視溫濕度趨勢，支援縮放、拖移與數據點查看。
*   **App 內更新:** 自動檢查 GitHub Releases 上的新版本。
    *   **可選頻道:** 使用者可選擇 **正式版 (Stable)**、**開發版 (Dev)**，或直接瀏覽**活躍開發分支**。
    *   **動態檢查:** App 會智慧地抓取所選頻道的最新建置設定檔 (例如 `update_dev.json`, `update_nightly.json`)。
    *   **正式版 (Stable):** 來自 `main` 分支的官方發布。
    *   **開發版 (Dev):** 來自 `dev` 分支的最新建置。
    *   **動態分支發現 (Dynamic Discovery):** App 會自動查詢 GitHub Releases API，列出所有活躍的開發分支 (標記為 `nightly-<branch>`)，讓您輕鬆測試特定功能分支。
*   **穩健的更新安裝:** 智慧處理 APK 下載與安裝，具備自動回退機制，確保在各種 Android 版本 (含 Android 13+) 上皆能順利安裝。
*   **多頻道 CI/CD:** 支援動態「功能分支 (Feature Branch)」發布。每個分支皆擁有獨立的更新頻道 (例如 `feat-new-ui`)，允許平行測試且互不干擾。

## 藍牙低功耗通訊協定 (Bluetooth Low Energy Protocol)

App 與 ESP32 智慧藥盒之間的通訊是基於 BLE UART 服務的自定義二進位協定。

**Service UUID:** `4fafc201-1fb5-459e-8fcc-c5c9c331914b`
**TX Characteristic (Write):** `beb5483e-36e1-4688-b7f5-ea07361b26a8`
**RX Characteristic (Notify):** `c8c7c599-809c-43a5-b825-1038aa349e5d`

### 指令列表 (App -> ESP32)

| 指令名稱 | OpCode | 參數 (Parameters) | 說明 |
| :--- | :---: | :--- | :--- |
| **取得協定版本** | `0x01` | 無 | 請求裝置回報協定版本 (回傳 `0x71`)。 |
| **同步時間** | `0x11` | `年(1B)`, `月(1B)`, `日(1B)`, `時(1B)`, `分(1B)`, `秒(1B)` | 同步 RTC 時間。年份為相對於 2000 年的數值 (例如 24 代表 2024)。 |
| **設定 Wi-Fi** | `0x12` | `SSID長度(1B)`, `SSID(...)`, `密碼長度(1B)`, `密碼(...)` | 發送 Wi-Fi 連線資訊給裝置。 |
| **設定工程模式** | `0x13` | `啟用(1B)` | `0x01`: 啟用, `0x00`: 停用。 |
| **取得工程模式狀態** | `0x14` | 無 | 查詢工程模式是否啟用 (回傳 `0x83`)。 |
| **取得狀態** | `0x20` | 無 | 請求當前的藥物狀態 (回傳 `0x80`)。 |
| **取得環境數據** | `0x30` | 無 | 單次請求當前的溫濕度 (回傳 `0x90`)。 |
| **取得歷史數據** | `0x31` | 無 | 請求儲存的環境歷史記錄 (回傳一系列 `0x91`，以 `0x92` 結束)。 |
| **訂閱即時數據** | `0x32` | 無 | 啟用環境數據自動推送。 |
| **設定鬧鐘** | `0x41` | `編號(1B)`, `時(1B)`, `分(1B)`, `啟用(1B)` | 設定硬體鬧鐘。`編號`: 0-3, `啟用`: 1/0。 |

### 回應列表 (ESP32 -> App)

| 回應名稱 | OpCode | 資料負載 (Payload) | 說明 |
| :--- | :---: | :--- | :--- |
| **協定回報** | `0x71` | `版本(1B)` | 回報協定版本 (例如 `0x03`)。 |
| **狀態回報** | `0x80` | `藥格遮罩(1B)` | 藥物格狀態的 Bitmask。 |
| **服藥通知** | `0x81` | `藥格編號(1B)` | 當使用者服藥時發送通知。 |
| **時間同步確認** | `0x82` | 無 | 確認時間已同步。 |
| **工程模式回報** | `0x83` | `狀態(1B)` | `0x01`: 已啟用, `0x00`: 已停用。 |
| **環境數據** | `0x90` | `溫度(2B)`, `濕度(2B)` | 即時感測器數據。數值為整數 (`Short`) (x100)。 |
| **歷史數據** | `0x91` | `時間戳(4B)`, `溫度(2B)`, `濕度(2B)` | 一筆或多筆歷史記錄。 |
| **同步完成** | `0x92` | 無 | 表示歷史數據傳輸結束。 |
| **錯誤回報** | `0xEE` | `錯誤碼(1B)` | `0x02`: 感測器錯誤, `0x03`: 未知指令, `0x04`: 存取錯誤。 |

## 藍牙協定版本控制

為了確保 App 功能持續更新的同時，仍能相容不同版本的 ESP32 韌體，我們引入了協定版本控制機制。

*   **握手 (Handshake):** App 連線後會主動詢問藥盒的協定版本 (指令 `0x01`)。
*   **向下相容:** App 會根據回報的版本號，自動調整資料解析邏輯。
    *   **版本 1:** 舊版協定 (單筆歷史數據傳輸)。
    *   **版本 2:** 支援批次歷史數據傳輸 (每包 5 筆) 與優化的整數型感測數據格式。
    *   **版本 3:** 新增鬧鐘設定功能 (指令 `0x41`)。

## 未來優化方向

我們持續致力於提升應用程式的品質與功能，目前的優化規劃包括：

*   **架構層面:**
    *   持續優化 Hilt 依賴注入 (Dependency Injection) 的使用。
    *   進一步完善 `StateFlow` 在資料流中的應用。
*   **程式碼品質:**
    *   持續進行 Linter 檢查，修復潛在的警告與排版問題。
    *   增加單元測試 (Unit Test) 與 UI 測試覆蓋率。
*   **UI/UX:**
    *   優化圖表顯示效能，支援更長區間的歷史數據查看。
    *   新增更多角色主題與客製化選項。
*   **穩定性:**
    *   增強藍牙連線的重連機制與錯誤處理。
    *   優化背景同步功能，確保數據不遺失。

## 開始使用

1.  **複製專案:** `git clone https://github.com/thumb2086/Medication_reminder.git`
2.  **開啟專案:** 使用 Android Studio (建議 Ladybug | 2024.2.1 或更新版本) 開啟。
3.  **編譯執行:** 連接 Android 手機 (Android 10+) 或使用模擬器執行。

## CI/CD 與版本自動化

本專案使用 GitHub Actions 進行持續整合與版本自動管理。

*   **正式發布 (Stable Releases):** 推送以 `v` 開頭的標籤 (例如 `v1.1.8`) 會觸發，建立永久 Release 至 `stable` 頻道。
*   **功能/開發發布:** 推送至 `dev`, `fix-*`, 或 `feat-*` 分支時觸發。
    *   自動產生該分支專屬的更新頻道 (例如 `update_feat_login.json`)。
    *   建置包含對應分支資訊的 APK。
    *   安裝特定分支 APK 的測試人員將只會收到該分支的後續更新。
*   **分支清理:** 當分支被刪除時，會自動移除對應的 Nightly Release 與 Tag，保持列表整潔。亦可透過 GitHub Actions workflow dispatch 手動執行清理。
*   **版本號碼:** `versionCode` 根據建置時間戳 (`yyMMddHH`) 產生，確保跨分支的版本號皆為單調遞增，避免降級安裝問題。
*   **Release 命名:** Nightly Release 現在使用更清晰的標題格式：`<Branch> | <VersionName>` (例如 `feat-ui | 1.2.0 nightly 205`)，以便清楚識別分支來源與版本資訊。

## 授權

[MIT License](LICENSE)
