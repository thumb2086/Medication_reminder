# Medication Reminder App (藥到叮嚀)

一款結合 ESP32 智慧藥盒的藥物提醒應用程式。協助使用者管理用藥排程、監控環境狀況，並透過手機通知與硬體警示確保按時服藥。

[![Android CI/CD](https://github.com/thumb2086/Medication_reminder/actions/workflows/android-cicd.yml/badge.svg)](https://github.com/thumb2086/Medication_reminder/actions/workflows/android-cicd.yml)

## 功能特色

*   **智慧提醒：** 可自訂藥物排程，包含頻率與時間設定。
*   **硬體整合：** 透過藍牙低功耗 (BLE) 與 ESP32 智慧藥盒無縫連接。
*   **即時監控：** 顯示來自藥盒感測器的即時溫濕度數據。
*   **服藥追蹤：** 記錄服藥歷史，並生成圖表以供依從性分析。
*   **主題切換：** 內建「庫洛米」與「櫻桃小丸子」主題，提供個人化體驗。
*   **工程模式：** 可直接從 App 切換硬體工程模式以進行診斷。
*   **Wi-Fi 設定：** 透過 BLE 直接設定 ESP32 的 Wi-Fi 連線。介面已全面升級為 Material Design 風格，並加入輸入驗證與清晰指引。
*   **鬧鐘系統：** 可在 ESP32 藥盒上設定最多 4 組硬體鬧鐘，提供獨立提醒功能。
*   **互動圖表：** 透過互動式折線圖檢視溫濕度趨勢，支援平移、縮放與數據點查看。
*   **App 內更新：** 自動檢查 GitHub Releases 上的新版本。
    *   **頻道選擇：** 使用者可在設定頁面選擇 **Stable (穩定版)**、**Dev (開發版)** 或瀏覽 **活躍中的開發分支**。
    *   **跨頻道切換：** 自由切換頻道 (例如從 Dev 切換到 Stable) 並安裝該分支的最新版本。
    *   **智慧預設頻道：** App 會根據當前安裝的版本自動設定預設更新頻道。
        *   **Stable 版本：** 預設為 `Main` 頻道。
        *   **Dev 版本：** 預設為 `Dev` 頻道。
        *   **功能分支版本：** 預設為該功能分支頻道 (例如 `feat-new-ui`)。
    *   **動態更新檢查：** 智慧抓取對應頻道的最新版本資訊 (例如 `update_dev.json`, `update_nightly.json`)。
        *   **安全檢查：** 偵測更新是否屬於不同頻道 (Application ID)，並警告使用者這將安裝另一個應用程式實例，而非原地更新。
    *   **Stable：** 來自 `main` 分支的正式發布版本。
    *   **Dev：** 來自 `dev` 分支的最新開發版本。
    *   **動態分支發現：** App 會查詢 GitHub Releases 以尋找活躍的分支 (標籤為 `nightly-<branch>`)，讓您能輕鬆測試特定功能分支。
*   **強健的更新安裝：** 智慧處理 APK 下載，具備自動 fallback 機制，確保在各種 Android 版本 (包含 Android 13+). 上皆能成功安裝。
*   **多頻道 CI/CD：** 支援動態「功能分支」發布。每個分支都有獨立的更新頻道 (例如 `feat-new-ui`)，允許並行測試而不互相干擾。

## 藍牙低功耗協定

App 與 ESP32 智慧藥盒之間的通訊基於自訂的二進位協定，透過 BLE UART 服務傳輸。

**服務 UUID：** `4fafc201-1fb5-459e-8fcc-c5c9c331914b`
**TX 特徵值 (寫入)：** `beb5483e-36e1-4688-b7f5-ea07361b26a8`
**RX 特徵值 (通知)：** `c8c7c599-809c-43a5-b825-1038aa349e5d`

### 指令參考 (App -> ESP32)

| 指令名稱 | OpCode | 參數 | 說明 |
| :--- | :---: | :--- | :--- |
| **取得協定版本** | `0x01` | 無 | 請求裝置回報協定版本 (回傳 `0x71`)。 |
| **同步時間** | `0x11` | `年(1B)`, `月(1B)`, `日(1B)`, `時(1B)`, `分(1B)`, `秒(1B)` | 同步 RTC 時間。年份為相對於 2000 年的值 (例如 24 代表 2024)。 |
| **設定 Wi-Fi** | `0x12` | `SSID長度(1B)`, `SSID(...)`, `密碼長度(1B)`, `密碼(...)` | 傳送 Wi-Fi 連線資訊至裝置。 |
| **設定工程模式** | `0x13` | `啟用(1B)` | `0x01`：啟用，`0x00`：停用。 |
| **取得工程模式狀態** | `0x14` | 無 | 查詢目前工程模式是否啟用 (回傳 `0x83`)。 |
| **取得狀態** | `0x20` | 無 | 請求目前藥盒狀態 (回傳 `0x80`)。 |
| **取得環境數據** | `0x30` | 無 | 單次請求目前溫濕度 (回傳 `0x90`)。 |
| **取得歷史數據** | `0x31` | 無 | 請求儲存的環境歷史記錄 (回傳一系列 `0x91`，以 `0x92` 結束)。 |
| **訂閱即時數據** | `0x32` | 無 | 啟用環境數據自動推送。 |
| **設定鬧鐘** | `0x41` | `Slot(1B)`, `時(1B)`, `分(1B)`, `啟用(1B)` | 設定硬體鬧鐘。`Slot`：0-3，`啟用`：1/0。 |

### 回應參考 (ESP32 -> App)

| 回應名稱 | OpCode | 資料負載 | 說明 |
| :--- | :---: | :--- | :--- |
| **協定回報** | `0x71` | `版本(1B)` | 回報協定版本 (例如 `0x03`)。 |
| **狀態回報** | `0x80` | `SlotMask(1B)` | 藥盒格位的狀態位元遮罩。 |
| **服藥通知** | `0x81` | `SlotID(1B)` | 當藥物被取出時通知。 |
| **時間同步確認** | `0x82` | 無 | 確認時間已同步。 |
| **工程模式回報** | `0x83` | `狀態(1B)` | `0x01`：已啟用，`0x00`：已停用。 |
| **環境數據** | `0x90` | `溫度(2B)`, `濕度(2B)` | 即時感測器數據。數值為 `Short` (x100)。 |
| **歷史數據** | `0x91` | `時間戳(4B)`, `溫度(2B)`, `濕度(2B)` | 一筆或多筆歷史記錄。 |
| **同步完成** | `0x92` | 無 | 表示歷史數據傳輸結束。 |
| **錯誤回報** | `0xEE` | `錯誤碼(1B)` | `0x02`：感測器錯誤，`0x03`：未知指令，`0x04`：存取錯誤。 |

## 藍牙協定版本控制

為確保 App 與 ESP32 韌體在功能演進過程中的相容性，引入了協定版本控制機制。

*   **握手：** 連線建立後，App 會向 ESP32 請求協定版本 (指令 `0x01`)。
*   **向下相容：** App 會根據回報的版本調整資料解析邏輯。
    *   **第 1 版：** 舊版協定 (單筆歷史記錄)。
    *   **第 2 版：** 批次歷史數據傳輸 (每封包 5 筆記錄) 與優化的整數型感測器數據格式。
    *   **第 3 版：** 新增鬧鐘設定支援 (指令 `0x41`)。

## 快速開始

1.  **複製專案：** `git clone https://github.com/thumb2086/Medication_reminder.git`
2.  **使用 Android Studio 開啟：** 將專案匯入 Android Studio (建議使用 Ladybug | 2024.2.1 或更新版本)。
3.  **建置並執行：** 連接 Android 裝置 (Android 10+) 或使用模擬器執行應用程式。

## CI/CD 與版本控制

本專案使用 GitHub Actions 進行持續整合與自動化版本管理。

*   **Stable 發布：** 推送以 `v` 開頭的標籤 (例如 `v1.1.8`) 時觸發。會在 `main` 頻道建立永久發布版本。
*   **Feature/Dev 發布：** 推送至 `dev`, `fix-*`, 或 `feat-*` 分支時觸發。
    *   為該分支產生專屬的更新頻道 (例如 `update_feat_login.json`)。
    *   建置對應版本名稱的 APK。
    *   安裝特定分支 APK 的測試人員將只會收到該分支的更新。
*   **統一命名：** 所有產出物 (APK) 與版本名稱嚴格遵循 `X.Y.Z-channel-count` 格式 (例如 `1.2.1-dev-255`)，移除空格與特殊字元，確保跨環境行為一致。
*   **分支清理：** 當分支被刪除時，對應的 Nightly Release 與 Tag 也會自動移除，保持發布列表整潔。亦支援透過 GitHub Actions workflow dispatch 手動清理。
*   **版本控制：** `versionCode` 採用 **Git Commit Count** 以確保 Android Build 與 CI Artifacts 的嚴格一致性。`versionName` 則採用 `1.2.1-dev-260` 格式。
*   **發布命名：** Nightly Release 現在使用更清晰的標題格式：`<分支> | <版本名稱>` (例如 `feat-ui | 1.2.0-nightly-205`)，方便識別來源分支與版本細節。
*   **動態基礎版本：** CI/CD 自動偵測最新的 Git Tag (例如 `v1.2.1`) 作為所有後續 Nightly 建置的基礎版本，確保版本名稱始終反映最新的穩定里程碑 (例如 `1.2.1-nightly-xxx`)。
*   **部署並發控制：** 實作並發控制，透過自動取消同一分支上的舊有工作流程，防止 `gh-pages` 部署衝突。

## 授權條款

[MIT License](LICENSE)
